name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        go-version: [1.17, 1.25]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
        cache: true
    
    - name: Verify dependencies
      run: go mod verify
    
    - name: Build
      run: go build -v ./...
    
    - name: Run tests
      run: go test -v -race -coverprofile=coverage.out -covermode=atomic -json ./... > test-results.json
    
    - name: Convert test results to JUnit format
      if: always()
      run: |
        go install github.com/jstemmer/go-junit-report/v2@latest
        cat test-results.json | go-junit-report -out test-results.xml
    
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Go Tests (Go ${{ matrix.go-version }})
        path: test-results.xml
        reporter: java-junit
    
    - name: Upload coverage reports to Codecov
      if: matrix.go-version == '1.25'
      uses: codecov/codecov-action@v3
      with:
        file: coverage.out
        flags: unittests
        name: codecov-umbrella